<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI偏差値診断｜メール登録→診断→結果メール</title>

  <style>
    :root{
      --brand:#7356b6; --bg:#f5f3ff; --card:#fff; --muted:#666; --ink:#222;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Arial, sans-serif;
      margin:0; color:var(--ink); background:var(--bg);
    }
    header{
      background:var(--brand); color:#fff;
      padding:18px; text-align:center;
    }
    main{max-width:980px; margin:24px auto; padding:0 16px 60px;}
    .card{
      background:var(--card);
      border-radius:12px; padding:22px;
      box-shadow: 0 6px 22px rgba(0,0,0,.06);
      margin:16px 0;
    }
    h1{font-size:22px; margin:0;}
    h2{font-size:18px; margin:12px 0}
    p{line-height:1.7; margin:8px 0}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    input[type="email"], select, button, .btn {
      font:inherit; padding:12px 14px;
      border-radius:10px; border:1px solid #ddd; background:#fff;
    }
    input[type="email"]{flex:1 1 320px; min-width:240px}
    button, .btn{
      background:var(--brand); border:none; color:#fff; cursor:pointer;
    }
    .ghost{ background:#fff; color:var(--brand); border:1px solid var(--brand); }
    .muted{ color:var(--muted); font-size:12px }
    .hint{ font-size:13px; color:#444 }
    .q{ border-top:1px dashed #e6e3f7; padding-top:12px; margin-top:12px }
    .radios{ display:flex; gap:12px; flex-wrap:wrap; margin-top:6px }
    .radios label{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid #ddd; border-radius:12px; background:#fff }
    .center{ text-align:center }
    .score{ font-size:28px; color:#6f5ad1; font-weight:700 }
    .level{ font-weight:700 }
    .cta{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px }
    .pill{ display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background:#eee; color:#555; }
    .ok{ color:#16784d } .warn{ color:#8a5a00 } .bad{ color:#a40000 }
    a.btn{ text-decoration:none; display:inline-block }
    .footer{ color:#777; font-size:12px; text-align:center; margin-top:24px }
    .badge{ background:#f1edff; color:#5d3fc0; padding:3px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
  <script>
/* 診断結果のスコアを検出して LP へ渡す＋保存 */
(function () {
  function computeLevel(score){
    if (score >= 70) return 'practical';   // 実践〜先進
    if (score >= 55) return 'middle';      // 初級〜中級
    return 'entry';                        // 入門
  }

  function updateLpLink() {
    // ページ内テキストから「総合スコア：NN」を拾う（日本語 UI 前提）
    const text = (document.querySelector('main')?.textContent || document.body.textContent || '').replace(/\s+/g, ' ');
    const m = text.match(/総合スコア\s*[:：]\s*(\d{1,3})/);
    if (!m) return;

    const score = parseInt(m[1], 10);
    const level = computeLevel(score);

    // 保存（LP が URLパラメータ無しでも拾えるように）
    localStorage.setItem('ai_score', String(score));
    localStorage.setItem('ai_level', level);

    // 「ExoVisionary Hubを見る」リンクを書き換え（見つかった最初の exo_lp.html リンクを対象）
    const link =
      document.querySelector('#link-lp') ||               // もし id を付けているなら優先
      document.querySelector('a[href*="exo_lp.html"]');   // 付いていなければ href で検索

    if (link) {
      const u = new URL('https://goro56project.github.io/ai_diagnosis/exo_lp.html');
      u.searchParams.set('score', String(score));
      u.searchParams.set('level', level);
      link.href = u.toString();
    }
  }

  // 画面表示後に実行（結果が描画されてから拾うため）
  window.addEventListener('load', () => setTimeout(updateLpLink, 0));
})();
</script>

<body>
  <header>
    <h1>AI偏差値診断</h1>
    <div class="muted">メール登録（任意） → 10問に回答 → 結果を表示 &amp; メール送信</div>
  </header>

  <main>
    <!-- STEP 1: メール登録（任意） -->
    <section id="step1" class="card">
      <div class="badge">STEP 1</div>
      <h2>診断結果をメールで受け取る（任意）</h2>
      <p class="hint">登録すると、診断後に結果をメールでもお送りします。未登録でも診断は可能です。</p>
      <div class="row">
        <input id="email" type="email" placeholder="メールアドレスを入力" autocomplete="email" />
        <button id="btnRegister">登録する</button>
        <a id="btnSkip" class="btn ghost" href="#step2">登録せずに診断へ</a>
      </div>
      <p class="muted">送信先の管理：Googleスプレッドシート（自動作成）／用途は診断に関するご連絡のみ。不要時はいつでも配信停止いただけます。</p>
      <div id="regMsg" class="muted"></div>
    </section>

    <!-- STEP 2: 質問 -->
    <section id="step2" class="card">
      <div class="badge">STEP 2</div>
      <h2>10問の自己評価に回答</h2>
      <div id="qWrap"></div>

      <div class="center" style="margin-top:16px">
        <button id="btnCalc" style="min-width:180px">診断する</button>
      </div>
    </section>

    <!-- STEP 3: 結果 -->
    <section id="step3" class="card">
      <div class="badge">STEP 3</div>
      <h2>診断結果</h2>

      <p>
        総合スコア： <span id="score" class="score">--</span>
        &nbsp;&nbsp; レベル： <span id="level" class="level">--</span>
      </p>
      <p id="advice" class="hint"></p>

      <div class="cta">
        <!-- ★ ここがご要望のリンク：LPファイルに直リンクさせています -->
        <a id="btn-allcourses" class="btn" href="./exo_lp.html">ExoVisionary Hubを見る</a>
        <a class="btn ghost" href="https://example.com/booking" target="_blank" rel="noopener">個別相談を予約</a>
      </div>

      <p class="muted" id="mailEcho" style="margin-top:8px;"></p>
    </section>

    <div class="footer">© ExoVisionary Hub</div>
  </main>

  <script>
    /* ========= 設定 ========= */
    // ★GAS（デプロイURL） — 置き換える場合はここだけ変更
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwg9IuBV3PKyfkepUdoRYI0J5wbQtX8NLU11BJl-UScoQSr9LRTNqnnofnX_6KDlvH0_w/exec";

    // 質問（10問）
    const QUESTIONS = [
      "ChatGPTなどのAIツールを業務で使ったことはありますか？",
      "プロンプト（AIへの指示文）を工夫して出力を改善した経験はありますか？",
      "業務フローの一部をAIで自動化・省力化したことがありますか？",
      "社内ルール・ガイドラインに沿ったAI活用を意識していますか？",
      "AI出力の品質管理（検証・レビュー）を実施していますか？",
      "データの取り扱い・守秘の観点で配慮して運用できていますか？",
      "RAG/外部データ連携などの拡張機能を扱ったことがありますか？",
      "チームでAI活用のナレッジ共有・教育を進めていますか？",
      "成果（コスト削減/時間短縮/売上寄与など）を可視化していますか？",
      "新しいAI機能・ツールを定期的に試し、評価していますか？"
    ];

    // レベル判定
    function levelOf(score){
      if (score >= 70) return { key:"advanced", label:"先進層" };
      if (score >= 55) return { key:"practical", label:"実践層" };
      if (score >= 40) return { key:"middle", label:"初級〜中級" };
      return { key:"entry", label:"入門層" };
    }

    // レベル別のひとこと
    const LEVEL_TIPS = {
      entry  : "まずは安全な使い方と用途探索から。社内ルールに沿って小さく試し、成功体験を。",
      middle : "プロンプト改善と検証プロセスの整備で品質を上げましょう。",
      practical: "評価・A/B・ガバナンスまで含めた運用設計を進めましょう。",
      advanced : "RAG/エージェントで事業インパクトへ！要件定義から運用SLAまで拡張を。"
    };

    /* ========= UI生成 ========= */
    const qWrap = document.getElementById("qWrap");
    QUESTIONS.forEach((text, idx) => {
      const n = idx + 1;
      const qEl = document.createElement("div");
      qEl.className = "q";
      qEl.innerHTML = `
        <div><b>${n}. ${text}</b></div>
        <div class="radios">
          ${[1,2,3,4,5].map(v => `
            <label>
              <input type="radio" name="q${n}" value="${v}">
              ${["全くない","少し","普通","かなり","とてもある"][v-1]}
            </label>
          `).join("")}
        </div>`;
      qWrap.appendChild(qEl);
    });

    /* ========= メール登録 ========= */
    const emailInput  = document.getElementById("email");
    const regMsg      = document.getElementById("regMsg");
    const btnRegister = document.getElementById("btnRegister");

    // 既存の保存値を復元
    emailInput.value = localStorage.getItem("adx_email") || "";

    btnRegister.addEventListener("click", async () => {
      const email = emailInput.value.trim();
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
        regMsg.textContent = "メール形式を確認してください。";
        return;
      }
      regMsg.textContent = "登録中…";
      try{
        await fetch(GAS_ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ type:"register", email })
        });
        localStorage.setItem("adx_email", email);
        regMsg.textContent = "登録しました。診断にお進みください。";
        location.hash = "#step2";
      }catch(e){
        regMsg.textContent = "登録に失敗しました。時間をおいて再度お試しください。";
      }
    });

    /* ========= 診断ロジック ========= */
    const btnCalc = document.getElementById("btnCalc");
    const scoreEl = document.getElementById("score");
    const levelEl = document.getElementById("level");
    const adviceEl= document.getElementById("advice");
    const mailEcho= document.getElementById("mailEcho");

    btnCalc.addEventListener("click", async () => {
      // 回答の収集
      const answers = {};
      for(let i=1;i<=QUESTIONS.length;i++){
        const val = document.querySelector(`input[name="q${i}"]:checked`)?.value;
        if(!val){ alert(`Q${i} が未回答です。`); return; }
        answers[`q${i}`] = Number(val);
      }
      // スコア計算（平均×20）
      const sum = Object.values(answers).reduce((a,b)=>a+b,0);
      const score = Math.round((sum / QUESTIONS.length) * 20);

      const lv = levelOf(score);
      scoreEl.textContent = score;
      levelEl.textContent = lv.label;
      adviceEl.textContent = LEVEL_TIPS[lv.key];

      // メール送信（GAS）
      const email = (localStorage.getItem("adx_email") || "").trim();
      mailEcho.textContent = email
        ? `結果を ${email} に送信しています（数分かかる場合があります）。`
        : "メール未登録のため、結果メールの送信はスキップしました。";

      try{
        await fetch(GAS_ENDPOINT, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ type:"result", email, score, answers })
        });
      }catch(e){
        // エラーはUIには出さない（画面表示優先）
        console.warn("send result failed:", e);
      }

      // 結果へスクロール
      location.hash = "#step3";
    });
  </script>
</body>
</html>
