<!DOCTYPE html>
<html lang="ja">
  <!-- GA4 / EVH Site -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQZF4F1QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-QFQZF4F1QW', { send_page_view: true, debug_mode: true });
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AI偏差値診断｜メール登録→診断→結果メール</title>
  <style>
    :root { --brand:#7356b6; --ink:#222; --card:#fff; --bg:#f5f3ff; --muted:#666; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui, -apple-system, Arial, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; margin:0; color:var(--ink); background:var(--bg);}
    header{ background:#fff; border-bottom:1px solid #eee; padding:18px; text-align:center; }
    main{ max-width:980px; margin:24px auto; padding:0 16px 60px 16px; }
    .card{ background:var(--card); border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:22px; margin:16px 0; }
    h1{ font-size:22px; margin:0;}
    h2{ font-size:18px; margin:8px 0 12px;}
    h3{ font-size:16px; margin:10px 0;}
    .muted{ color:var(--muted); }
    .lead{ line-height:1.7; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    input[type="email"], select, .btn, .btn-link{
      font:inherit; padding:12px 14px; border-radius:10px; border:1px solid #ddd; background:#fff;
    }
    .btn{ cursor:pointer; }
    .btn.primary{ background:var(--brand); border-color:var(--brand); color:#fff; }
    .btn.ghost{ background:#fff; border-color:#ddd; color:var(--ink); }
    .btn.block{ width:100%; text-align:center; }
    .pill{ display:inline-block; background:#eee; padding:.25em .6em; border-radius:999px; font-size:.9em;}
    fieldset{ border:1px solid #eee; border-radius:12px; padding:14px; margin:10px 0;}
    .qgrid{ display:grid; grid-template-columns: 1fr repeat(5, minmax(60px, 80px)); gap:8px 12px; align-items:center;}
    .qgrid .choice{ text-align:center; }
    .result{ display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
    .score{ font-size:28px; color:var(--brand); font-weight:700; }
    ul.bullets{ margin:8px 0 0 20px; }
    .right{ text-align:right; }
    .hint{ font-size:12px; color:#777; }
  </style>
</head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQZF4F1QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  // 既定で page_view が送られます
  gtag('config', 'G-QFQZF4F1QW', { transport_type: 'beacon' });
</script>

<body>
  <header>
    <h1>AI偏差値診断</h1>
    <div class="muted">メール登録（任意）→ 設問10問 → 結果表示・LPへ</div>
  </header>

  <main>
    <!-- STEP 1: メール登録（任意） -->
    <section class="card">
      <h2>STEP 1｜診断結果をメールで受け取る（任意）</h2>
      <p class="lead muted">登録すると、診断後に同じ内容をメールでお送りします。未登録でも診断は可能です。</p>
      <div class="row">
        <input id="email" type="email" inputmode="email" placeholder="メールアドレスを入力" style="flex:1;min-width:240px;">
        <button id="btn-register" class="btn primary">登録する</button>
        <button id="btn-skip" class="btn ghost">登録せずに診断へ</button>
      </div>
      <div class="hint">送信先の管理：Google スプレッドシート（自動作成）／ 用途は診断に関するご連絡のみ。不要時はいつでも停止できます。</div>
    </section>

    <!-- STEP 2: 設問 -->
    <section class="card">
      <h2>STEP 2｜10問の自己評価に回答</h2>

      <!-- 1行の凡例 -->
      <div class="qgrid muted" style="font-size:12px; margin-bottom:6px;">
        <div></div>
        <div class="choice">全くない</div>
        <div class="choice">少し</div>
        <div class="choice">普通</div>
        <div class="choice">かなり</div>
        <div class="choice">とてもある</div>
      </div>

      <!-- 質問テンプレ（JSが生成でもOKだが、ここでは直書き） -->
      <div id="questions"></div>

      <div class="right" style="margin-top:14px;">
        <button id="btn-diagnose" class="btn primary">診断する</button>
      </div>
    </section>

    <!-- STEP 3: 結果 -->
    <section class="card" id="result-card">
      <h2>STEP 3｜診断結果</h2>
      <p class="result">
        <span>AI偏差値：</span>
        <span class="score"><span id="score-out">--</span></span>
        <span>/ 100</span>
        <span class="pill">レベル：<span id="lv-label">--</span></span>
      </p>
      <p id="result-lead" class="lead muted" style="margin-top:4px;">診断後にサマリを表示します。</p>
      <ul id="result-bullets" class="bullets"></ul>

      <div class="row" style="margin-top:14px;">
        <!-- ★ このリンクを“クリック送信”に変更（id=lp-link を必ず付与） -->
        <a id="lp-link" class="btn primary" href="./exo_lp.html">ExoVisionary Hubを見る</a>
        <a class="btn ghost" href="#" id="btn-consult">個別相談を予約</a>
      </div>

      <div class="hint" style="margin-top:10px;">メール未登録のため、結果メールの送信はスキップしました。</div>
    </section>
  </main>

  <!-- =============== JS =============== -->
  <script>
  /*** 設定 ***/
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwg9IuBV3PKyfkepUdoRYI0J5wbQtX8NLU11BJl-UScoQSr9LRTNqnnofnX_6KDlvH0_w/exec"; // 変更可
  const LP_PATH = "./exo_lp.html"; // LPファイル（同一リポ内）

  /*** 状態 ***/
  const state = {
    email: "",
    score: null,
    levelLabel: "",
    lvKey: "",
    answers: {} // {q1:1..5,...}
  };

  /*** 質問の生成 ***/
  const QUESTIONS = [
    "ChatGPTなどのAIツールを業務で使ったことはありますか？",
    "プロンプト（AIへの指示文）を工夫して出力を改善した経験はありますか？",
    "AIで作った成果物の品質レビュー（基準）が社内にありますか？",
    "得られた成果をテンプレ／型として蓄積し再利用していますか？",
    "複数の業務ツールとAIを組み合わせて効率化できていますか？",
    "AIの出力に関するセキュリティ・ルールが整備されていますか？",
    "部門横断でAI活用のガイドラインや成功事例を共有していますか？",
    "AIを用いた評価・検証（A/Bや指標化）を行えていますか？",
    "自動化・RAG・エージェント等の本格運用に着手していますか？",
    "新しいAI機能・ツールを定期的に試し、評価していますか？"
  ];

  const $qsWrap = document.getElementById("questions");
  QUESTIONS.forEach((label, idx) => {
    const n = "q" + (idx + 1);
    const fs = document.createElement("fieldset");
    const lg = document.createElement("legend");
    lg.textContent = `${idx+1}. ${label}`;
    fs.appendChild(lg);

    const grid = document.createElement("div");
    grid.className = "qgrid";
    grid.innerHTML = `
      <div></div>
      ${[1,2,3,4,5].map(v => `
        <label class="choice">
          <input type="radio" name="${n}" value="${v}" ${v===3?'checked':''} />
        </label>
      `).join("")}
    `;
    fs.appendChild(grid);
    $qsWrap.appendChild(fs);
  });

  /*** スコア計算・レベル判定 ***/
  function gatherAnswers() {
    const a = {};
    for (let i=1;i<=10;i++){
      const sel = document.querySelector(`input[name="q${i}"]:checked`);
      a["q"+i] = sel ? Number(sel.value) : 3; // 未回答は普通=3
    }
    return a;
  }
  function calcScore(answers){
    const sum = Object.values(answers).reduce((s,v)=>s+Number(v||0),0); // 10〜50
    return Math.max(0, Math.min(100, Math.round(sum * 2))); // 0〜100にスケール
  }
  function levelFrom(score){
    if (score>=70) return {label:"先進層", key:"practical"};
    if (score>=55) return {label:"実践層", key:"practical"};
    if (score>=40) return {label:"初級〜中級", key:"middle"};
    return {label:"入門層", key:"entry"};
  }

  /*** 表示更新 ***/
  const $scoreOut = document.getElementById("score-out");
  const $lvLabel  = document.getElementById("lv-label");
  const $lead     = document.getElementById("result-lead");
  const $bullets  = document.getElementById("result-bullets");

  const LEADS = {
    entry:"まずは安全な使い方と型を整えて、短期で成果を出す土台を作ります。",
    middle:"品質と効率を同時に上げる短期集中プランをおすすめします。",
    practical:"評価・検証〜運用設計までを含め、再現性のある仕組み化へ踏み込みましょう。"
  };
  const BULLETS = {
    entry:[
      "基本リテラシーと安全ルールを整備",
      "業務テンプレ/良いプロンプトの型を準備",
      "小さく試して成功体験を蓄積"
    ],
    middle:[
      "業務テンプレの整備と自動化の入口",
      "評価・検証フレームとA/B運用",
      "短期集中プラン（成果レビュー）"
    ],
    practical:[
      "要件整理・導入ロードマップの設計",
      "運用SLA設計とガバナンス",
      "RAG/エージェントの社内展開"
    ]
  };

  function renderResult(){
    $scoreOut.textContent = (state.score ?? "--");
    $lvLabel.textContent  = state.levelLabel || "--";
    $lead.textContent     = LEADS[state.lvKey] || "";
    $bullets.innerHTML    = (BULLETS[state.lvKey]||[]).map(t=>`<li>${t}</li>`).join("");
  }

  /*** GAS 連携（任意） ***/
  async function postGAS(payload){
    try{
      await fetch(GAS_URL, { method:"POST", body: JSON.stringify(payload) });
    }catch(_){ /* 失敗してもUIは継続 */ }
  }

  /*** クリックでLPへ安全に値を渡す（この回答のポイント） ***/
  (function initClickSend(){
    const link = document.getElementById("lp-link");
    if(!link) return;

    link.addEventListener("click", (e)=>{
      e.preventDefault();

      // 直前の選択から再計算（常に最新）
      state.answers = gatherAnswers();
      state.score   = calcScore(state.answers);
      const lv      = levelFrom(state.score);
      state.levelLabel = lv.label;
      state.lvKey      = lv.key;
      renderResult(); // 表示も更新

      // URLにクエリで付与
      const url = new URL(LP_PATH, location.href);
      url.searchParams.set("score", String(state.score));
      url.searchParams.set("level", state.levelLabel);
      url.searchParams.set("lv",    state.lvKey);
      if (!url.hash) url.hash = "#flow";

      // バックアップ（同一ブラウザなら読める）
      localStorage.setItem("ai_diag_payload",
        JSON.stringify({ score:state.score, levelLabel:state.levelLabel, lvKey:state.lvKey, ts:Date.now() })
      );

      // 遷移
      location.href = url.toString();
    });
  })();

  /*** イベント ***/
  document.getElementById("btn-register").addEventListener("click", async ()=>{
    const v = (document.getElementById("email").value||"").trim();
    if(!v || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)){ alert("メールアドレスを入力してください"); return; }
    state.email = v;
    await postGAS({ type:"register", email:v });
    alert("登録しました。診断後に結果メールをお送りします。");
  });

  document.getElementById("btn-skip").addEventListener("click", ()=>{
    window.scrollTo({top: document.getElementById("questions").offsetTop - 60, behavior:"smooth"});
  });

  document.getElementById("btn-diagnose").addEventListener("click", async ()=>{
    state.answers = gatherAnswers();
    state.score   = calcScore(state.answers);
    const lv      = levelFrom(state.score);
    state.levelLabel = lv.label;
    state.lvKey      = lv.key;
    renderResult();

    // GASへ結果送信（任意）
    if (state.email){
      await postGAS({ type:"result", email:state.email, score:state.score, answers:state.answers });
    }
    // 結果までスムーズにスクロール
    document.getElementById("result-card").scrollIntoView({behavior:"smooth"});
  });

  // 相談ボタン（必要ならリンク先を書き換え）
  document.getElementById("btn-consult").addEventListener("click",(e)=>{
    e.preventDefault();
    alert("個別相談の導線を設定してください（Calendly/フォーム等のURL）");
  });
  </script>
</body>
</html>

